{% extends "base.html" %}
{% block content %}

<div class="container py-4">
  <div class="row">
    <div class="col">
      <h1 class="h3 mb-1">TimeZone</h1>
      <p class="text-muted">Welcome, {{ current_user.name }}!</p>
    </div>
    <div class="col">
      {# Flash messages #}
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% for category, msg in messages %}
          <div class= "mt-1 alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ msg }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endwith %}
    </div>
  </div>

  <!-- Nav pills -->
  <ul class="nav nav-pills mb-4 mt-1" id="adminTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button
        class="nav-link active"
        id="tab-timezone"
        data-bs-toggle="pill"
        data-bs-target="#pane-timezone"
        type="button"
        role="tab"
      >
        <i class="bi bi-people me-1"></i>
        TimeZone
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button
        class="nav-link"
        id="tab-machines"
        data-bs-toggle="pill"
        data-bs-target="#pane-machines"
        type="button"
        role="tab"
      >
        <i class="bi bi-person-plus me-1"></i>
        Nearby Machines
      </button>
    </li>
  </ul>

  <!-- Tab panes -->
  <div class="tab-content" id="adminTabsContent">
    <!-- TimeZone Pane -->
    <div
      class="tab-pane fade show active"
      id="pane-timezone"
      role="tabpanel"
      aria-labelledby="tab-timezone">
      <div class="row mt-4 mb-2">
        <div class="col d-flex align-items-center justify-content-center">
          <div class="card mt-4 h-100 img-fluid shadow-sm p-4">
            <img src="{{ url_for('static', filename='tzlogo2.png') }}" class="card-img-top" alt="tzlogo" style="max-height:100px; width:auto;">
            <div class="card-body d-flex flex-column">
              <h5 class="card-title">Start your working day</h5>
              <button id="startBtn" class="btn btn-primary"> Start dagen</button>
              <p id="statusmsg" class="mt-2 text-muted"></p>
              <p id="timerDisplay" class="mt-2 fw-bold"></p> 
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Machines Pane -->
    <div
      class="tab-pane fade"
      id="pane-machines"
      role="tabpanel"
      aria-labelledby="tab-machines"
    >
      <div class="row mt-4 mb-2">
        <div class="col">
          <div class="card shadow-sm p-4">
            <img src="{{ url_for('static', filename='bluetooth-logo-1.png') }}" class="card-img-top img-fluid w-50 mx-auto d-block" alt="...">
            <p class="mx-auto d-block">Requires Chrome or a Chromium browser, and the "Experimental Web Platform Features" flag set to enabled.
              (chrome://flags/#enable-experimental-web-platform-features)</p>
              <button id="scanBtn" class="btn btn-primary">Scan for Machines (Active 10s)</button>
          </div>
        </div>
      </div>
      <div class="row mt-4 mb-2">
        <div class="col">
          <div class="card shadow-sm p-4 mt-4 mb-4">
            <table class="table table-striped mb-0">
              <thead>
                <p class="mx-auto d-block"><b>Machines found nearby:</b></p>
                <tr>
                  <th>Machine</th><th>Distance</th><th>Action</th>
                </tr>
              </thead>
              <tbody id="beaconTable">
                
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="row mt-4 mb-2">
        <div class="col">
          <div class="card shadow-sm p-4 mt-4 mb-4">
            <table class="table table-striped mb-0">
              <thead>
                <p class="mx-auto d-block"><b>Already active machines:</b></p>
                <tr>
                  <th>Machine</th>
                </tr>
              </thead>
              <tbody>
                {% if active_machines %}
                  {% for m in active_machines %}
                    <tr>
                      <td>{{ m }}</td>
                    </tr>
                  {% endfor %}
                {% endif %}
                {% if not active_machines %}
                  <tr>
                    <td>No active machines</td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
    </div>  
  </div>
</div>


<!-- Save the list of active machines, to be able to change start button to stop button -->
<script>
  const activeMachines = JSON.parse('{{ active_machines|tojson|safe }}') || [];
  console.log("Already active machines:", activeMachines)
</script>

<!-- GO BACK AND LOOK AT THIS LATER, REMOVE HARDCODED UUIDS FROM HTML, SEND THEM FROM SERVER, BAD BAD NO SECURE -->
<script>
document.getElementById('scanBtn').addEventListener('click', async () => {
  const tbody = document.getElementById('beaconTable');
  tbody.innerHTML = '';                   // clear old rows

  const MY_UUIDS = [
    'e1d807c6-6dd4-4345-a744-9c5b492144c1',
    'f5ed34bf-1091-4715-8886-52cb7c606411',
    '3843a27a-1e93-4a1b-a89e-b0e0cef97c50',
    '5bae6c80-d05f-44bd-b093-59b8d4d9aba5'
  ];

  navigator.bluetooth.addEventListener('advertisementreceived', event => {
    const found = (event.uuids || []).find(u => MY_UUIDS.includes(u));
    if (!found) return;

    // BLE Beacon sends name, lifetime, and battery level in the name field
    // Split device name by '|'
    // First entry is the name, second is lifetime, third is battery percentage
    const data = event.device.name.split("|") || '<no data>';
    const name = data[0] || '<no name>';
    const lifetime = data[1] || '<no lifetime>';
    const pct = data[2] || '<no battery>';
    // The squiggly bit "~" inverts the RSSI value, so it becomes positive
    const rssi = ~event.rssi;
    
    var distance = '';

    if (rssi < 50) {
      distance = 'Very close';
    }
    else if (rssi < 70) {
      distance = 'Close';
    }
    else if (rssi < 90) {
      distance = 'Far away';
    }
    else {
      distance = 'Very far away';
    }
    

    // see if we already have a row for this beacon
    let row = tbody.querySelector(`tr[data-uuid="${found}"]`);
    if (row) {
      // update the Distance cell
      row.cells[1].textContent = distance;
    } else {
      // create a new row
      row = document.createElement('tr');
      row.setAttribute('data-uuid', found);

      const tdName = document.createElement('td');
      tdName.textContent = name;

      const tdDistance = document.createElement('td');
      tdDistance.textContent = distance;

      const tdAction = document.createElement('td');
      const btn = document.createElement('button');
      btn.className = 'btn btn-sm';
      tdAction.appendChild(btn);

      row.appendChild(tdName);
      row.appendChild(tdDistance);
      row.appendChild(tdAction);
      tbody.appendChild(row);
    }
    
    const btn = row.querySelector('button');
    const isActive = Array.isArray(activeMachines) && activeMachines.includes(name);
    btn.textContent = isActive ? 'STOP' : 'START';
    btn.classList.toggle('btn-success', !isActive);
    btn.classList.toggle('btn-danger',  isActive);

    // Click-handler: POST to API and update activeMachines locally
    btn.onclick = async () => {
      try {
        const res = await fetch('/api/timezone_machine/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ uuid: found, lifetime: lifetime, pct: pct })
        });
        const payload = await res.json();
        // Quick sanity check, to see the API response code
        //alert("API response: " + res.status + " Payload:" + payload.success);
        if (res.status !== 200 || payload.success !== true) {
          throw new Error(payload.error || `HTTP ${res.status}`);
        }

        // reflect the change in our JS array
        if (isActive) {
          alert('Machine stopped');
          //const idx = activeMachines.indexOf(name);
          //if (idx > -1) activeMachines.splice(idx, 1);
        } else {
          alert('Machine started');
          //activeMachines.push(name);
        }

        // flip button after success
        btn.textContent = isActive ? 'START' : 'STOP';
        btn.classList.toggle('btn-success', isActive);
        btn.classList.toggle('btn-danger',  !isActive);
        location.reload();
      } catch (err) {
        console.error('API error:', err);
        alert('Request failed');
      }
    };
  });

  try {
    const scan = await navigator.bluetooth.requestLEScan({
      filters: MY_UUIDS.map(u => ({ services: [u] })),
      keepRepeatedDevices: false
    });
    setTimeout(() => scan.stop(), 10_000);
  } catch (err) {
    console.error('Scan failed:', err);
    alert('Scan failed: ' + err);
  }
});
</script>

<!-- Tobias JS -->
<script>
  console.log("java er indlæst");

  const startBtn = document.getElementById("startBtn");
  const statusMsg = document.getElementById("statusmsg");
  const timerDisplay = document.getElementById("timerDisplay");

  let startTime = null;
  let timer = null;
  let working = false;

  function startTimer() {
    startTime = new Date();
    timer = setInterval(() => {
      const now = new Date();
      const forskellen = Math.floor((now - startTime) / 1000);
      const hours = Math.floor(forskellen/ 3600).toString().padStart(2, '0');
      const minutes = Math.floor((forskellen % 3600) / 60).toString().padStart(2, '0');
      const seconds = (forskellen % 60).toString().padStart(2, '0');
      timerDisplay.innerText = `Tid i gang: ${hours}:${minutes}:${seconds}`;
    },1000);
  }

  function stopTimer() {
    clearInterval(timer);
    timerDisplay.innerText = "";
  }

  startBtn.addEventListener("click", function () {
    console.log("startBtn clicked");
    statusMsg.innerText = "";
    startBtn.disabled = true;


    fetch("{{ url_for('timezone_user_api') }}", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      credentials: "same-origin"
    })
    .then(response => {
      if (!response.ok) {
        throw new Error("pisse lort fejl" + response.status);
      }
      return response.json();
    })
    .then (data =>{
      if (data.status === "success" || data.status === "great success") {
        if (data.action === "start") {
          startBtn.innerText = "Stop din dejlige dag";
          startBtn.classList.replace("btn-primary", "btn-danger");
          statusMsg.innerText = data.message;
          working = true;
          startTimer();
        } 
        else if (data.action === "stop") {
            console.log("stop action received");
           startBtn.innerText = "Er du allerede færdig?";
           startBtn.classList.replace("btn-danger", "btn-success");           
           statusMsg.innerText = data.message;
           working = false;
           stopTimer();
          
        
          setTimeout(() => {
            startBtn.innerText = "Vil du starte igen taber kylling?";
            startBtn.className = "btn btn-primary";
            startBtn.disabled = false;
            statusMsg.innerText = "";
            working = false;
          }, 3000);  
        }
      } else {
        statusMsg.innerText = "kæmpe lortefejl lorte it folk: " + data.message;
      }

      setTimeout(() => {
        startBtn.disabled = false;
      }, 3000); 
    })
    .catch(error => {
      statusMsg.innerText ="skyd mig der ingen forbindelse til serveren";
      console.error("Error:", error);
      startBtn.disabled = false;
    
    });
  });
</script>
{% endblock %}
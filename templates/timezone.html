{% extends "base.html" %}
{% block content %}

<div class="container py-4">
  <div class="row">
    <div class="col">
      <h1 class="h3 mb-1">TimeZone</h1>
      <p class="text-muted">Welcome, {{ current_user.name }}!</p>
    </div>
    <div class="col">
      {# Flash messages #}
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% for category, msg in messages %}
          <div class= "mt-1 alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ msg }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endwith %}
    </div>
  </div>

  <!-- Nav pills -->
  <ul class="nav nav-pills mb-4 mt-1" id="adminTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button
        class="nav-link active"
        id="tab-timezone"
        data-bs-toggle="pill"
        data-bs-target="#pane-timezone"
        type="button"
        role="tab"
      >
        <i class="bi bi-people me-1"></i>
        TimeZone
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button
        class="nav-link"
        id="tab-machines"
        data-bs-toggle="pill"
        data-bs-target="#pane-machines"
        type="button"
        role="tab"
      >
        <i class="bi bi-person-plus me-1"></i>
        Nearby Machines
      </button>
    </li>
  </ul>

  <!-- Tab panes -->
  <div class="tab-content" id="adminTabsContent">
    <!-- TimeZone Pane -->
    <div
      class="tab-pane fade show active"
      id="pane-timezone"
      role="tabpanel"
      aria-labelledby="tab-timezone">
      <div class="row mt-4 mb-2">
        <div class="col d-flex align-items-center justify-content-center">
          <div class="card mt-4 h-100 img-fluid" style="max-width: 300px; height: 120px; display: inline-block; object-fit: cover;">
            <img src="{{ url_for('static', filename='tzlogo2.png') }}" class="card-img-top" alt="...">
            <div class="card-body d-flex flex-column">
              <h5 class="card-title">Start your working day</h5>
              <p class="card-text">Get to work you lazy bastard >:|</p>
              <button id="startBtn" class="btn btn-primary" action="{{ url_for('timezone_user_api') }}">Start Day</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Machines Pane -->
    <div
      class="tab-pane fade"
      id="pane-machines"
      role="tabpanel"
      aria-labelledby="tab-machines"
    >
      <div class="row mt-4 mb-2">
        <div class="col">
          <div class="card shadow-sm p-4">
            <img src="{{ url_for('static', filename='bluetooth-logo-1.png') }}" class="card-img-top img-fluid w-50 mx-auto d-block" alt="...">
            <p class="mx-auto d-block">Requires Chrome or a Chromium browser, and the "Experimental Web Platform Features" flag set to enabled.
              (chrome://flags/#enable-experimental-web-platform-features)</p>
              <button id="scanBtn" class="btn btn-primary">Scan for Machines (Active 10s)</button>
          </div>
        </div>
      </div>
      <div class="row mt-4 mb-2">
        <div class="col">
          <div class="card shadow-sm p-4 mt-4 mb-4">
            <table class="table table-striped mb-0">
              <thead>
                <tr>
                  <th>Machine</th><th>RSSI</th><th>Action</th>
                </tr>
              </thead>
              <tbody id="beaconTable">
                
              </tbody>
            </table>
          </div>
        </div>
      </div>

      
    </div>  
  </div>
</div>

  

<!-- GO BACK AND LOOK AT THIS LATER, REMOVE HARDCODED UUIDS FROM HTML, SEND THEM FROM SERVER, BAD BAD NO SECURE -->
<script>
document.getElementById('scanBtn').addEventListener('click', async () => {
  const tbody = document.getElementById('beaconTable');
  tbody.innerHTML = '';                   // clear old rows

  const MY_UUIDS = [
    'e1d807c6-6dd4-4345-a744-9c5b492144c1',
    'f5ed34bf-1091-4715-8886-52cb7c606411',
    '3843a27a-1e93-4a1b-a89e-b0e0cef97c50',
    '5bae6c80-d05f-44bd-b093-59b8d4d9aba5'
  ];

  navigator.bluetooth.addEventListener('advertisementreceived', event => {
    const found = (event.uuids || []).find(u => MY_UUIDS.includes(u));
    if (!found) return;

    const name = event.device.name || '<no name>';
    const rssi = event.rssi;

    // see if we already have a row for this beacon
    let row = tbody.querySelector(`tr[data-uuid="${found}"]`);
    if (row) {
      // update the RSSI cell
      row.cells[1].textContent = rssi;
    } else {
      // create a new row
      row = document.createElement('tr');
      row.setAttribute('data-uuid', found);

      const tdName = document.createElement('td');
      tdName.textContent = name;

      const tdRssi = document.createElement('td');
      tdRssi.textContent = rssi;

      const tdAction = document.createElement('td');
      const btn = document.createElement('button');
      btn.textContent = "START";
      btn.className = 'btn btn-success btn-sm';
      btn.addEventListener('click', async () => {
      try {
        const res = await fetch('/api/timezone_machine', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ uuid: found, name, rssi })
        });
        if (!res.ok) throw new Error(res.statusText);
        alert("Machine time started successfully");
      } catch (err) {
        console.error(err);
        alert('Report failed');
      }
    });
      tdAction.appendChild(btn);

      row.appendChild(tdName);
      row.appendChild(tdRssi);
      row.appendChild(tdAction);
      tbody.appendChild(row);
    }
  });

  try {
    const scan = await navigator.bluetooth.requestLEScan({
      filters: MY_UUIDS.map(u => ({ services: [u] })),
      keepRepeatedDevices: false
    });
    setTimeout(() => scan.stop(), 10_000);
  } catch (err) {
    console.error('Scan failed:', err);
    alert('Scan failed: ' + err);
  }
});
</script>

{% endblock %}
{% extends "base.html" %}

{% block content %}

<style>
  #adminTabs .nav-link { background: #ffffff; color: #495057; }
  #tab-manage.active, #tab-create.active, #tab-edit.active {
    background: #0d6efd; color: #fff;
  }
</style>

<div class="container py-4">
  <div class="row">
    <div class="col">
      <h1 class="h3 mb-1">Org Control Panel</h1>
      <p class="text-muted">Welcome, {{ current_user.name }}!</p>
    </div>
    <div class="col">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% for category, msg in messages %}
          <div class="mt-1 alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ msg }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endwith %}
    </div>
  </div>

  <!-- Nav Pills -->
  <ul class="nav nav-pills mb-4 mt-1" id="adminTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="tab-manage" data-bs-toggle="pill" data-bs-target="#pane-manage" type="button" role="tab">
        <i class="bi bi-people me-1"></i>User List
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-create" data-bs-toggle="pill" data-bs-target="#pane-create" type="button" role="tab">
        <i class="bi bi-person-plus me-1"></i>Employee Schedule
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-edit" data-bs-toggle="pill" data-bs-target="#pane-edit" type="button" role="tab">
        <i class="bi bi-pencil-square"></i>Overview of hours worked
      </button>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content" id="adminTabsContent">

    <!-- User List -->
    <div class="tab-pane fade show active" id="pane-manage" role="tabpanel" aria-labelledby="tab-manage">
      <div class="card shadow-sm p-4">
        <table class="table table-striped mb-0">
          <thead>
            <tr>
              <th>Name</th><th>Lastname</th><th>Email</th><th>Hours</th>
            </tr>
          </thead>
          <tbody>
            {% for u in users %}
              <tr>
                <td>{{ u.name }}</td>
                <td>{{ u.lastname }}</td>
                <td>{{ u.email }}</td>
                <td>TEST</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Overview Tab -->
    <div class="tab-pane fade" id="pane-edit" role="tabpanel" aria-labelledby="tab-edit">
      <div class="card shadow-sm p-4 mb-4">
        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label class="form-label">Select User:</label>
            <select id="userSelectOverview" class="form-select">
              <option value="">- Select User -</option>
              {% for u in users %}
                <option value="{{ u.id }}">{{ u.name }} {{ u.lastname }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Calendar Date Range Picker -->
        <div class="row">
          <div class="col-sm-6 mb-3 mb-sm-0">
            <div data-coreui-locale="en-US" data-coreui-toggle="date-range-picker"></div>
          </div>
          <div class="col-sm-6">
            <div
              data-coreui-start-date="2022/08/03"
              data-coreui-end-date="2022/08/17"
              data-coreui-locale="en-US"
              data-coreui-toggle="date-range-picker">
            </div>
          </div>
        </div>

        <!-- Output -->
        <div id="currentMonthResult" class="fw-bold mt-3"></div>
        <ul id="currentMonthWorkList" class="list-group mt-2"></ul>

      </div>
    </div>

    <!-- Empty Schedule Tab -->
    <div class="tab-pane fade" id="pane-create" role="tabpanel" aria-labelledby="tab-create">
      <div class="card shadow-sm p-4">Schedule content goes here.</div>
    </div>

  </div>
</div>

<!-- JS Section -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Simulated work data
    const workData = [
      { userId: 1, date: '2025-05-01', hours: 8 },
      { userId: 1, date: '2025-05-10', hours: 6 },
      { userId: 1, date: '2025-05-21', hours: 4 },
      { userId: 2, date: '2025-05-05', hours: 7 },
      { userId: 2, date: '2025-05-20', hours: 5 },
      { userId: 3, date: '2025-04-18', hours: 9 } // previous month
    ];

    // Overview hours worked this month
    const userSelectOverview = document.getElementById('userSelectOverview');
    const resultBox = document.getElementById('currentMonthResult');
    const resultList = document.getElementById('currentMonthWorkList');

    userSelectOverview.addEventListener('change', () => {
      const userId = parseInt(userSelectOverview.value);
      resultBox.textContent = '';
      resultList.innerHTML = '';

      if (!userId) return;

      const today = new Date();
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();

      const filtered = workData.filter(entry => {
        const entryDate = new Date(entry.date);
        return (
          entry.userId === userId &&
          entryDate.getMonth() === currentMonth &&
          entryDate.getFullYear() === currentYear
        );
      });

      if (filtered.length > 0) {
        let totalHours = 0;
        filtered.forEach(entry => {
          totalHours += entry.hours;
          const li = document.createElement('li');
          li.className = 'list-group-item';
          li.textContent = `${entry.date}: ${entry.hours} hours`;
          resultList.appendChild(li);
        });
        const monthName = today.toLocaleString('default', { month: 'long' });
        resultBox.textContent = `Total hours worked in ${monthName}: ${totalHours}`;
      } else {
        resultBox.textContent = 'No records found for this user this month.';
      }
    });
  });
</script>

{% endblock %}
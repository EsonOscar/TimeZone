{% extends "base.html" %}

{% block content %}

<style>
  /* non-active pills */
  #adminTabs .nav-link { background: #ffffff; color: #495057; }
  /* override each active pill */
  #tab-manage.active  { background: #0d6efd; color: #fff; }
  #tab-create.active  { background: #0d6efd; color: #fff; }
  #tab-edit.active    { background: #0d6efd; color: #fff; }
  #tab-delete.active  { background: #dc3545; color: #fff; }
</style>

<div class="container py-4">
  <div class="row">
    <div class="col">
      <h1 class="h3 mb-1">SysAdmin Control Panel</h1>
      <p class="text-muted">Welcome, {{ current_user.name }}!</p>
    </div>
    <div class="col">
      {# Flash messages #}
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% for category, msg in messages %}
          <div class= "mt-1 alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ msg }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endwith %}
    </div>
  </div>
  
  

  <!-- Nav pills -->
  <ul class="nav nav-pills mb-4 mt-1" id="adminTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button
        class="nav-link active"
        id="tab-manage"
        data-bs-toggle="pill"
        data-bs-target="#pane-manage"
        type="button"
        role="tab"
      >
        <i class="bi bi-people me-1"></i>
        User List
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button
        class="nav-link"
        id="tab-create"
        data-bs-toggle="pill"
        data-bs-target="#pane-create"
        type="button"
        role="tab"
      >
        <i class="bi bi-person-plus me-1"></i>
        Create User
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button
        class="nav-link"
        id="tab-edit"
        data-bs-toggle="pill"
        data-bs-target="#pane-edit"
        type="button"
        role="tab"
      >
        <i class="bi bi-pencil-square"></i>
        Edit User
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button
        class="nav-link"
        id="tab-delete"
        data-bs-toggle="pill"
        data-bs-target="#pane-delete"
        type="button"
        role="tab"
      >
        <i class="bi bi-trash"></i>
        Delete User
      </button>
    </li>
  </ul>

  <!-- Tab panes -->
  <div class="tab-content" id="adminTabsContent">
    <!-- Manage Users Pane -->
    <div
      class="tab-pane fade show active"
      id="pane-manage"
      role="tabpanel"
      aria-labelledby="tab-manage"
    >
      <div class="card shadow-sm p-4">
        <table class="table table-striped mb-0">
          <thead>
            <tr>
              <th>Name</th><th>Lastname</th><th>Email</th><th>Role</th><th>Registered</th><th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for u in users %}
            <tr>
              <td>{{ u.name }}</td>
              <td>{{ u.lastname }}</td>
              <td>{{ u.email }}</td>
              <td>{{ u.role.replace('_',' ') }}</td>
              <td>{{ u.signup }}</td>
              <td>
                <a href=""
                   class="btn btn-sm btn-outline-secondary disabled">
                   Edit
                </a>
                <a href=""
                   class="btn btn-sm btn-outline-danger disabled">
                   Delete
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Create User Pane -->
    <div
      class="tab-pane fade"
      id="pane-create"
      role="tabpanel"
      aria-labelledby="tab-create"
    >
      <div class="card shadow-sm p-4 mb-4">
        <form method="POST" action="{{ url_for('admin_create_user') }}">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">First Name</label>
              <input name="name" class="form-control" required>
            </div>
            <div class="col-md-4">
                <label class="form-label">Last Name</label>
                <input name="lastname" class="form-control" required>
              </div>
            <div class="col-md-4">
              <label class="form-label">Email</label>
              <input name="email" type="email" class="form-control"required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Username</label>
              <input name="username" class="form-control" required>
            </div>
            <div class="col-md-4">
                <label class="form-label">Initial Password</label>
                <input name="password" type="password" class="form-control" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Role</label>
              <select name="role" class="form-select">
                <option value="sysadmin">SysAdmin</option>
                <option value="org_admin">Organisation Admin</option>
                <option value="employee">Employee</option>
              </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Pay type</label>
                <select name="paytype" class="form-select">
                  <option value="salary">Salary</option>
                  <option value="hourly">Hourly rate</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Amount (DKK)</label>
                <input name="pay" class="form-control" required>
            </div>
          </div>
          <button type="submit" class="btn btn-primary mt-4">
            Create User
          </button>
        </form>
      </div>
    </div>

    <!-- Edit User Pane -->
    <div
    class="tab-pane fade"
    id="pane-edit"
    role="tabpanel"
    aria-labelledby="tab-edit"
    >

      <div class="card shadow-sm p-4 mb-4">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Select a user to edit:</label>
            <select id="userSelectEdit" class="form-select">
              <option value="">- Select User -</option>
              {% for u in users %}
                <option value="{{ u.id }}">
                  {{ u.name }} {{ u.lastname }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>

      
      <div class="card shadow-sm p-4 mb-4">
        <form id="editForm" method="POST" action="" class="row g-3">
          <div class="col-md-4">
            <label class="form-label">First Name</label>
            <input id="inpName"   name="name"      class="form-control" disabled>
          </div>
          <div class="col-md-4">
            <label class="form-label">Last Name</label>
            <input id="inpLast"   name="lastname"  class="form-control" disabled>
          </div>
          <div class="col-md-4">
            <label class="form-label">Email</label>
            <input id="inpEmail"  name="email"     type="email" class="form-control" disabled>
          </div>
          <div class="col-md-4">
            <label class="form-label">Username</label>
            <input id="inpUser"   name="username"  class="form-control" disabled>
          </div>
          <div class="col-md-4">
            <label class="form-label">Role</label>
            <select id="inpRole"  name="role"      class="form-select" disabled>
              <option value="sysadmin">SysAdmin</option>
              <option value="org_admin">Organisation Admin</option>
              <option value="employee">Employee</option>
            </select>
          </div>
          <br>
          <div class="col-md-4">
            <label class="form-label">Pay Type</label>
            <select id="inpPaytype"  name="paytype"      class="form-select" disabled>
              <option value="salary">Salary</option>
              <option value="hourly">Hourly</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Pay (DKK)</label>
            <input id="inpPay" name="pay"    class="form-control" disabled>
          </div>

          <div class="col-12">
            <button id="btnSave" type="submit" class="btn btn-primary" disabled>
              Save Changes
            </button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Delete User Pane -->
    <div
    class="tab-pane fade"
    id="pane-delete"
    role="tabpanel"
    aria-labelledby="tab-delete"
    >

      <div class="card shadow-sm p-4 mb-4">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Select a user to delete:</label>
            <select id="userSelectDelete" class="form-select">
              <option value="">- Select User -</option>
              {% for u in users %}
                <option value="{{ u.id }}">
                  {{ u.name }} {{ u.lastname }}
                </option>
              {% endfor %}
            </select>
            <button id="btnDelete" type="submit" class="btn btn-danger" disabled>
              Delete User
            </button>
          </div>
        </div>
      </div>

  </div>
</div>

<!-- JS for filling out / sending the edit user form -->
<script>
  document.getElementById('userSelectEdit').addEventListener('change', async function() {
    const userId = this.value;
    const form   = document.getElementById('editForm');
    const btn    = document.getElementById('btnSave');
  
    if (!userId) {
      // No user selected → disable form
      form.reset();
      form.querySelectorAll('input, select, button').forEach(el => el.disabled = true);
      return;
    }
  
    try {
      // Fetch that user’s data
      const resp = await fetch(`/api/user/${userId}`);
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
  
      const u = await resp.json();
  
      // Fill out the form with the user’s data
      document.getElementById('inpName').value       = u.name;
      document.getElementById('inpLast').value       = u.lastname;
      document.getElementById('inpEmail').value      = u.email;
      document.getElementById('inpUser').value       = u.username;
      document.getElementById('inpRole').value       = u.role;
      document.getElementById('inpPaytype').value    = u.paytype;
      document.getElementById('inpPay').value        = u.pay;
  
      // Enable all fields when a user is chosen
      form.querySelectorAll('input, select, button').forEach(el => el.disabled = false);
  
      // Point the POST action at the correct update route
      form.action = `/api/update/${userId}`;
    }
    catch(err) {
      alert('Failed to load user data: ' + err);
    }
  });
</script>

<!-- JS for deleting a user -->
<script>
  document.getElementById('userSelectDelete').addEventListener('change', function() {
    const userId = this.value;
    const btn    = document.getElementById('btnDelete');
  
    if (!userId) {
      // No user selected → disable button
      btn.disabled = true;
      return;
    }
  
    // Enable the delete button
    btn.disabled = false;
  
    // Set the delete button's action to the correct route
    btn.onclick = function() {
      window.location.href = `/api/delete/${userId}`;
    };
  });
</script>

<!-- JS for searchable dropdown menus -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    new Choices('#userSelectEdit', {
      searchEnabled: true,
      shouldSort: false,
      itemSelectText: ''
    });
    new Choices('#userSelectDelete', {
      searchEnabled: true,
      shouldSort: false,
      itemSelectText: ''
    });
  });
</script>
{% endblock %}

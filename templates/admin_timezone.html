{% extends "base.html" %}
{% block content %}

<!-- Flash messages and header -->
<div class="container py-4">
  <div class="row">
    <div class="col">
      <h1 class="h3 mb-1">Admin TimeZone</h1>
      <p class="text-muted">Welcome, {{ current_user.name }}!</p>
    </div>
    <div class="col">
      {# Flash messages #}
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% for category, msg in messages %}
          <div class= "mt-1 alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ msg }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endwith %}
    </div>
  </div>

  <div class="row mt-4 mb-2">
    <div class="col d-flex align-items-center justify-content-center">
      <div class="card mt-4 h-100 img-fluid shadow-sm p-4">
        <img src="{{ url_for('static', filename='tzlogo2.png') }}" class="card-img-top" alt="tzlogo" style="max-height:100px; width:auto;">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">Start your working day</h5>
          <button id="startBtn" class="btn btn-primary"> Start dagen</button>
          <p id="statusmsg" class="mt-2 text-muted"></p>
          <p id="timerDisplay" class="mt-2 fw-bold"></p> 
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Tobias JS -->
<script>
  console.log("java er indlæst");

  const startBtn = document.getElementById("startBtn");
  const statusMsg = document.getElementById("statusmsg");
  const timerDisplay = document.getElementById("timerDisplay");

  let startTime = null;
  let timer = null;
  let working = false;

  function startTimer() {
    startTime = new Date();
    timer = setInterval(() => {
      const now = new Date();
      const forskellen = Math.floor((now - startTime) / 1000);
      const hours = Math.floor(forskellen/ 3600).toString().padStart(2, '0');
      const minutes = Math.floor((forskellen % 3600) / 60).toString().padStart(2, '0');
      const seconds = (forskellen % 60).toString().padStart(2, '0');
      timerDisplay.innerText = `Tid i gang: ${hours}:${minutes}:${seconds}`;
    },1000);
  }

  function stopTimer() {
    clearInterval(timer);
    timerDisplay.innerText = "";
  }

  startBtn.addEventListener("click", function () {
    console.log("startBtn clicked");
    statusMsg.innerText = "";
    startBtn.disabled = true;


    fetch("{{ url_for('timezone_user_api') }}", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      credentials: "same-origin"
    })
    .then(response => {
      if (!response.ok) {
        throw new Error("pisse lort fejl" + response.status);
      }
      return response.json();
    })
    .then (data =>{
      if (data.status === "success" || data.status === "great success") {
        if (data.action === "start") {
          startBtn.innerText = "Stop din dejlige dag";
          startBtn.classList.replace("btn-primary", "btn-danger");
          statusMsg.innerText = data.message;
          working = true;
          startTimer();
        } 
        else if (data.action === "stop") {
            console.log("stop action received");
           startBtn.innerText = "Er du allerede færdig?";
           startBtn.classList.replace("btn-danger", "btn-success");           
           statusMsg.innerText = data.message;
           working = false;
           stopTimer();
          
        
          setTimeout(() => {
            startBtn.innerText = "Vil du starte igen taber kylling?";
            startBtn.className = "btn btn-primary";
            startBtn.disabled = false;
            statusMsg.innerText = "";
            working = false;
          }, 3000);  
        }
      } else {
        statusMsg.innerText = "kæmpe lortefejl lorte it folk: " + data.message;
      }

      setTimeout(() => {
        startBtn.disabled = false;
      }, 3000); 
    })
    .catch(error => {
      statusMsg.innerText ="skyd mig der ingen forbindelse til serveren";
      console.error("Error:", error);
      startBtn.disabled = false;
    
    });
  });
</script>
{% endblock %}